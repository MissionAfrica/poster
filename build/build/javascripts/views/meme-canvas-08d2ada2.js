var headlineBase=0,nameBase=0;MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var e=document.createElement("canvas"),t=MEME.$("#meme-canvas");e&&e.getContext?(t.html(e),this.canvas=e,this.setDownload(),this.render()):t.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var e=document.createElement("a");"undefined"==typeof e.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function e(e){var t=d.background.height,a=d.background.width;if(t&&a){var n=t*r.imageScale,o=a*r.imageScale,i=r.backgroundPosition.x||r.width/2,l=r.backgroundPosition.y||r.height/2;e.drawImage(d.background,0,0,a,t,i-o/2,l-n/2,o,n)}}function t(e){r.overlayColor&&(e.save(),e.globalAlpha=1,e.fillStyle=r.themeData[r.theme].background,e.fillRect(0,0,r.width,r.height),e.globalAlpha=1,e.restore())}function a(e){var t=r.width-u,a=u,n=r.height/2;e.font=r.fontSize+"pt "+r.themeData[r.theme].headlineFont,e.fillStyle=r.themeData[r.theme].headline,e.textBaseline="top",r.textShadow&&(e.shadowColor="#666",e.shadowOffsetX=-2,e.shadowOffsetY=1,e.shadowBlur=10),e.textAlign="left";for(var o=r.headlineText.split("\n"),i=0;i<o.length;i++){var l=o[i].split(" "),h="";i>0&&(n+=Math.round(1.55*r.fontSize));for(var d=0;d<l.length;d++){var s=h+l[d]+" ",m=e.measureText(s),c=m.width;c>t&&d>0?(e.fillText(h,a,n-10),h=l[d]+" ",n+=Math.round(1.55*r.fontSize)):h=s}e.fillText(h,a,n-10)}headlineBase=n+Math.round(1.55*r.fontSize)-10}function n(e){e.globalAlpha=r.watermarkAlpha,e.drawImage(d.watermark,0,0,595,377),e.globalAlpha=1}function o(e){e.fillStyle=r.themeData[r.theme].name,e.font="normal "+Math.round(.6*r.fontSize)+"pt "+r.themeData[r.theme].nameFont,nameBase=headlineBase+Math.round(2.2*r.nameSize);for(var t=u,a=headlineBase+4,n=r.width-u,o=r.nameText.split("\n"),i=0;i<o.length;i++){var l=o[i].split(" "),h="";i>0&&(a+=Math.round(1.55*r.nameSize));for(var d=0;d<l.length;d++){var s=h+l[d]+" ",m=e.measureText(s),c=m.width;c>n&&d>0?(e.fillText(h,t,a-10),h=l[d]+" ",a+=Math.round(r.fontSize)):h=s}e.fillText(h,t,a-10)}}function i(e){if(0!==r.roundelText.length&&r.roundel){var t=r.roundelPosition.x||r.width/2,a=r.roundelPosition.y||r.height/2,n=100;e.fillStyle=r.themeData[r.theme].roundelBackground,e.arc(t,a,n/2,0,2*Math.PI,!1),e.fill()}}function l(e){if(0!==r.roundelText.length&&r.roundel&&"undefined"!=typeof r.roundel){var t=16,a=-17,n=r.roundelPosition.x||r.width/2,o=r.roundelPosition.y||r.height/2;e.font="normal "+t+"pt "+r.themeData[r.theme].font,e.fillStyle=r.themeData[r.theme].roundelColor,e.textAlign="center";for(var i=60,l=r.roundelText.split(" "),h="",d=0;d<l.length;d++){var s=h+l[d]+" ",u=e.measureText(s),m=u.width;m>i&&d>0?(e.fillText(h,n,o+a),h=l[d]+" ",o+=Math.round(1.45*t)):h=s}e.fillText(h,n,o+a)}}function h(e){e.drawImage(d.footer,30,746,403,66)}if(this.canvas){var d=this.model,r=this.model.toJSON(),s=this.canvas.getContext("2d"),u=Math.round(r.width*r.paddingRatio);this.canvas.width=r.width,this.canvas.height=r.height,s.clearRect(0,0,r.width,r.height),t(s),i(s),l(s),e(s),a(s),n(s),o(s),h(s);var m=this.canvas.toDataURL();this.$("#meme-download").attr({href:m,download:(r.downloadName||"share")+".png"}),this.canvas.style.cursor=r.roundel||this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(e){function t(e){e.preventDefault(),a.set(o,{x:l.x-(i.x-e.clientX),y:l.y-(i.y-e.clientY)})}if(e.preventDefault(),this.model.hasBackground()||this.model.hasRoundel()){var a=this.model,n=a.toJSON();switch(n.dragging){case"background":var o="backgroundPosition",i={x:e.clientX,y:e.clientY},l=n.backgroundPosition;l.x=l.x||n.width/2,l.y=l.y||n.height/2;break;case"roundel":if(!this.model.hasRoundel())return;var o="roundelPosition",i={x:e.clientX,y:e.clientY},l=n.roundelPosition;l.x=l.x||n.width/2,l.y=l.y||n.height/2}var h=MEME.$(document).on("mousemove.drag",t).on("mouseup.drag",function(e){h.off("mouseup.drag mousemove.drag"),t(e)})}}});